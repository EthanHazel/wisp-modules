name: Trigger Wisp Deployment

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - modules/**
      - scripts/**
      - style/**

jobs:
  trigger-deployment:
    runs-on: ubuntu-latest
    steps:
      - name: Trigger deployment in wisp
        run: |
          curl -X POST -H "Accept: application/vnd.github+json" \
               -H "Authorization: Bearer ${{ secrets.ACTION_TOKEN }}" \
               -H "X-GitHub-Api-Version: 2022-11-28" \
               https://api.github.com/repos/WispTools/wisp-web/actions/workflows/main.yml/dispatches \
               -d '{"ref":"main"}'
  discord-notification:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Get modified files
        id: get-modified-files
        uses: actions/github-script@v6
        with:
          script: |
            const commit = await github.rest.repos.getCommit({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: context.sha
            });
            const modifiedFiles = commit.data.files.map(file => {
              if (file.status === 'modified') return 'üîπ ' + file.filename;
              if (file.status === 'added') return '‚ûï ' + file.filename;
              if (file.status === 'removed') return '‚ùå ' + file.filename;
            }).filter(Boolean);
            return modifiedFiles.join('\n');

      - name: Discord Webhook Action
        uses: tsickert/discord-webhook@v6.0.0
        with:
          webhook-url: ${{ secrets.DISCORD_WEBHOOK_URL }}
          embed-color: 2723899
          embed-author-name: ${{ github.event.head_commit.message }}
          embed-author-url: https://github.com/${{ github.repository }}/commit/${{ github.sha }}
          embed-description: |
            Author: ${{ github.event.head_commit.author.name }}

            ${{ steps.get-modified-files.outputs.result }}
